using System;
namespace SoftwareMonkeys.csAnt.SetUpFromWebConsole
{
    public class CodePlexDownloader
    {
        public CodePlexDownloader ()
        {
        }
        
        static public void DownloadReleaseZip(string url, bool overwrite)
        {
            var zipFile = Environment.CurrentDirectory
                + Path.DirectorySeparatorChar
                    + "csAnt.zip";

            new FileDownloader().Download(url, zipFile, overwrite);

            var zipper = new FileZipper();

            var unzippedPath = Environment.CurrentDirectory
                + Path.DirectorySeparatorChar
                    + "_csAnt-Unzipped";

            zipper.Unzip(zipFile, unzippedPath, "/");

            InstallFilesFromRelease(unzippedPath, overwrite);
        }

        static public void InstallFilesFromRelease(string unzippedPath, bool overwrite)
        {
            Console.WriteLine ("");
            Console.WriteLine ("Installing files:");

            foreach (var file in Directory.GetFiles (unzippedPath, "*", SearchOption.AllDirectories))
            {
                var toFile = file.Replace(unzippedPath, Environment.CurrentDirectory);

                if (!File.Exists (toFile) || overwrite)
                {
                    File.Copy(file, toFile);

                    Console.WriteLine (toFile.Replace(Environment.CurrentDirectory, ""));
                }
                else
                {
                    Console.WriteLine ("Skipped: " + toFile.Replace(Environment.CurrentDirectory, ""));
                }
            }
            Console.WriteLine ("");
        }

        static public string GetUrl(string releaseKey)
        {


            var url = "https://csant.codeplex.com/releases/view/119623";
    
            var xpath = "//a[@class='ReleaseLink']";
    
            var prefix = "https://csant.googlecode.com/files/";
    //http://download-codeplex.sec.s-msft.com/Download/Release?ProjectName=csant&DownloadId=812541&FileTime=130390907814570000&Build=20885
            var data = ScrapeLinks(
                url,
                xpath
            );

            var releasePageUrl = (
                from k in data.Keys
                where k == releaseKey
                select data[k]
            ).ToArray()[0];
    
            /*

            foreach (string releaseName in data.Keys)
            {
                Console.WriteLine (releaseName);
                if (releaseName == releaseKey)
                {    
                    releasePageUrl = data[releaseName];
                    break;
                }
            }*/

            var xpath2 = "//a[@class='FileNameLink']";

            if (string.IsNullOrEmpty(releasePageUrl))
                throw new Exception("Failed to retrieve download information from CodePlex.");

            var data2 = ScrapeLinks(releasePageUrl, xpath2);

            var releaseFinalLink = "";

            foreach (string releaseFileName in data2.Keys)
            {
                Console.WriteLine (releaseFileName);
                Console.WriteLine (data2[releaseFileName]);
                /*if (releaseFileName.IndexOf(releaseKey + "-") == 0)
                {    
                    releasePageUrl = data[releaseName];
                }*/

                releaseFinalLink = data2[releaseFileName];
            }

            //WebKit.
    
            return String.Empty;
        }
        
        static public Dictionary<string, string> ScrapeLinks(
            string url,
            string xpath
        )
        {
            var web = new HtmlWeb();
    
            var doc = web.Load(url);
    
            var nodes = doc.DocumentNode.SelectNodes(xpath);
    
            var dict = new Dictionary<string, string>();
    
            if (nodes != null)
            {    
                foreach (var node in nodes)
                {
                    var name = "";
                    var releasePageUrl = "";

                    if (!String.IsNullOrEmpty(node.InnerText.Trim ()))
                        name = node.InnerText.Trim ();

                    if (!String.IsNullOrEmpty(node.Attributes["href"].Value.Trim ()))
                        releasePageUrl = node.Attributes["href"].Value.Trim ();

                    dict.Add (name, releasePageUrl);
                }
            }
    
            return dict;
        }
    }
}


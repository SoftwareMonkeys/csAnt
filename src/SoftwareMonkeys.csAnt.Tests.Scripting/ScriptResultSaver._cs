using System;
using System.IO;
using System.Xml.Serialization;
using System.Collections.Generic;

namespace SoftwareMonkeys.csAnt.Tests.Scripting
{
	public class ScriptResultSaver
    {
        public ITestScript Script { get; set; }

        public ScriptXmlResultFileNamer FileNamer { get; set; }

		public ScriptResultSaver (
            ITestScript script,
            ScriptXmlResultFileNamer fileNamer
		)
		{
            Script = script;
            FileNamer = fileNamer;
		}

		public void Save (ScriptResult result)
        {
            if (String.IsNullOrEmpty(result.ScriptName))
                throw new ArgumentException("The result.ScriptName property is empty.");

            var filePath = FileNamer.GetXmlFileName(Script);

            if (Script.IsVerbose) {
                Console.WriteLine ("");
                Console.WriteLine ("Saving test script result...");
                Console.WriteLine ("Script name:");
                Console.WriteLine (result.ScriptName);
                Console.WriteLine ("Log length:");
                Console.WriteLine (result.Log != null ? result.Log.Length.ToString() : "0");
                Console.WriteLine ("Current dir:");
                Console.WriteLine (result.Script.CurrentDirectory);
                Console.WriteLine ("File:");
                Console.WriteLine (filePath);
                Console.WriteLine ("Success:");
                Console.WriteLine (result.Succeeded);
            }

			result.Script.EnsureDirectoryExists (Path.GetDirectoryName (filePath));
			
			using (var writer = File.CreateText(filePath))
			{
				var serializer = new XmlSerializer(result.GetType());
				serializer.Serialize(writer, result);
			}

            result.Script.AddSummary("Output test script result to: " + filePath);
		}

        // TODO: Remove function if not needed
        public Stack<string> GetTestScriptStack()
        {
            var detector = new TestScriptStackDetector(Script);

            return detector.Detect();
        }
	}
}


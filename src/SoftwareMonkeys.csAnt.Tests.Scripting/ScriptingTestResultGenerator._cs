using System;
using System.IO;

namespace SoftwareMonkeys.csAnt.Tests.Scripting
{
	public class ScriptingTestResultGenerator
	{
		public ITestScript Script { get;set; }
        
        public ScriptXmlResultFileNamer XmlReportFileNamer { get; set; }
        public ScriptHtmlResultFileNamer HtmlReportFileNamer { get; set; }

        public ScriptHtmlResultGenerator HtmlReportGenerator { get; set; }

        public ScriptingTestResultGenerator (ITestScript script)
        {
            Construct(
                script
            );
        }

		public ScriptingTestResultGenerator (
			ITestScript script,
            ScriptXmlResultFileNamer xmlReportFileNamer,
            ScriptHtmlResultFileNamer htmlReportFileNamer,
            ScriptHtmlResultGenerator htmlReportGenerator
		)
		{
			Construct(
                script,
                xmlReportFileNamer,
                htmlReportFileNamer,
                htmlReportGenerator
            );
		}
        
        public void Construct (
            ITestScript script
        )
        {
            var xmlReportFileNamer = new ScriptXmlResultFileNamer();

            var htmlReportFileNamer = new ScriptHtmlResultFileNamer();

            Construct(
                script,
                xmlReportFileNamer,
                htmlReportFileNamer,
                new ScriptHtmlResultGenerator(
                    script,
                    xmlReportFileNamer,
                    htmlReportFileNamer
                )
            );
        }

        public void Construct (
            ITestScript script,
            ScriptXmlResultFileNamer xmlReportFileNamer,
            ScriptHtmlResultFileNamer htmlReportFileNamer,
            ScriptHtmlResultGenerator htmlReportGenerator
        )
        {
            Script = script;
            XmlReportFileNamer = xmlReportFileNamer;
            HtmlReportFileNamer = htmlReportFileNamer;
            HtmlReportGenerator = htmlReportGenerator;

            if (Script.IsVerbose) {
                Console.WriteLine ("");
                Console.WriteLine ("Constructing ScriptReportGenerator...");
                Console.WriteLine ("Script name: " + Script.ScriptName);
            
                Console.WriteLine ("Current directory:");
                Console.WriteLine (Script.CurrentDirectory);
                Console.WriteLine ("");
            }
        }

		public virtual void GenerateReports()
		{
            if (Script.IsVerbose) {
                Console.WriteLine ("");
                Console.WriteLine ("Generating test reports for scripts...");
                Console.WriteLine ("Original directory:");
                Console.WriteLine (Script.OriginalDirectory);
                Console.WriteLine ("Current directory:");
                Console.WriteLine (Script.CurrentDirectory);
            }

			GenerateXmlReports();

			GenerateHtmlReports();
		}

		public virtual void GenerateXmlReports()
		{
			// TODO: Check if this should be injected
			var result = new ScriptResult(
				Script,
				!Script.IsError,
				Script.Console.Output,
				new ScriptResultSaver(
                    Script,
                    XmlReportFileNamer
				)
			);

			result.Save();

		}

		public virtual void GenerateHtmlReports()
		{
			HtmlReportGenerator.Generate();
		}
	}
}

